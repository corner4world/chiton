#!/bin/bash

set -e
#set -x
#dbc_debug=1

export PATH="/sbin:/usr/sbin:$PATH"
POSTINST=true
CONFIGURE=true
HAVEDBCONF=false


MYSQL_HOST="localhost"
MYSQL_DB=@PKGNAME@
MYSQL_INSTALL_USER="root"
MYSQL_INSTALL_PW=""
MYSQL_USER=@PKGNAME@
MYSQL_USER_PW=changeme

#init for debian
#DEBHELPER#
if [ -f /usr/share/debconf/confmodule ]; then
    . /usr/share/debconf/confmodule
    HAVEDBCONF=true
    if [ "$1" == "configure" ] || [ "$1" == "reconfigure" ]; then
        CONFIGURE=true
    else
        CONFIGURE=false
    fi

fi

STATE_DIR=@localstatedir@/@PKGNAME@
RUN_DIR=@runstatedir@
WEBUSER=@webuser@
VID_DIR=$STATE_DIR/vids
BACKEND_USER=@PKGNAME@
HTML_SRC_DIR=@pkgdatadir@/web
APACHE_CFG_DIR=@apachecfgdir@
CFGDIR=@cfgdir@
WEBDIR=/chiton

#add our user
if ! getent passwd $BACKEND_USER > /dev/null ; then
    echo "Adding the user $BACKEND_USER"
    useradd $BACKEND_USER -d $STATE_DIR -r -U
fi

#add the webserver to our group
if ! id -Gn $BACKEND_USER | grep -wqE "\b$WEBUSER\b" > /dev/null ; then
    usermod -a -G $BACKEND_USER $WEBUSER
fi

#setup the directories
if [ ! -d $STATE_DIR/compile ]; then
    mkdir -p $STATE_DIR/compile
fi

if [ ! -d $STATE_DIR/cache ]; then
    mkdir -p $STATE_DIR/cache
fi

if [ ! -d $VID_DIR ]; then
    mkdir -p $VID_DIR
fi

if [ ! -d $RUN_DIR ]; then
    mkdir -p $RUN_DIR
fi

chown $BACKEND_USER:$BACKEND_USER  $STATE_DIR $VID_DIR $STATE_DIR/compile $STATE_DIR/cache $RUN_DIR
chmod 770 $STATE_DIR/compile $STATE_DIR/cache $VID_DIR
chmod 755 $RUN_DIR

rm -f @localstatedir@/@PKGNAME@/cache/*.php @localstatedir@/@PKGNAME@/compile/*.php || true

if [ -f /usr/share/dbconfig-common/dpkg/postinst.mysql ]; then
    . /usr/share/dbconfig-common/dpkg/postinst.mysql
    dbc_go @PKGNAME@ "$@" || true
    echo "postinst: $@ $dbc_dbserver"
    MYSQL_HOST="$dbc_dbserver"
    MYSQL_DB="$dbc_dbname"
    MYSQL_USER="$dbc_dbuser"
    MYSQL_USER_PW="$dbc_dbpass"
    chiton-install -yqk -H "$MYSQL_HOST" -d "$MYSQL_DB" -U "$MYSQL_USER" -p "$MYSQL_USER_PW"
fi


#restart everything...on debian
if [ "@inittype@" == "systemd" ]; then
    systemctl daemon-reload || true
    deb-systemd-helper enable chiton.service || true
    deb-systemd-invoke start chiton.service || true
    deb-systemd-invoke restart apache2.service || true
else
    #we always overwrite it, but keep the execute bit
    if [ -e etc/rc.d/rc.chiton ] && [ -r etc/rc.d/rc.chiton.new ]; then
        mv etc/rc.d/rc.chiton.new etc/rc.d/rc.chiton
        chmod +x etc/rc.d/rc.chiton
    else
        mv etc/rc.d/rc.chiton.new etc/rc.d/rc.chiton
    fi
fi
